BS = BS or {}

BS.Version = 0.772

BS.SpectatorPID = 17

BS.CurrentMappoolTotalAmount = 0

BS.MapList = {
			[1] =	{
				},
			[2] =	{
				["(2) testmap"] = true,
				["(2) koop canyon"] = true,
				["(2) koop castrum"] = true,
				["(2) koop eisiger fjord"] = true,
				["(2) koop kerberos dunkle horden"] = true,
				["(2) koop vereinter widerstand"] = true,
				["(2) koop dunkelheit"] = true,
				["(2) koop kampf oder flucht"] = true,
				["(2) koop schlacht um evelance"] = true,
				["(2) koop vargs bergfestung"] = true,
				["(2) koop bergpass"] = true,
				["(2) koop alte zeiten"] = true,
				["(2) koop evelance schrecken"] = true,
				["(2) koop helft halberstaedt"] = true,
				["(2) koop silbertal"] = true,
				["(2) koop trockenzeit"] = true,
				["(2) koop winterplateau"] = true,
				["(2) koop erste pruefung - kampfgeschick"] = true,
				["(2) koop zweite pruefung - taktische finesse"] = true,
				["(2) koop dritte pruefung - gesandter des himmels"] = true,
				["(2) koop vierte pruefung - das artefakt"] = true,
				["(2) koop fuenfte pruefung - die dunkle bedrohung"] = true,
				["(2) koop sechste pruefung - der boese graf"] = true,
				["(2) koop siebte pruefung - tanz der flammen"] = true,
				["(2) koop achte pruefung - shering in gefahr"] = true,
				["(2) koop neunte pruefung - rettet trogteburg"] = true,
				["(2) koop eisigerfjord (remastered)"] = true,
				["(2) koop eingekesselt"] = true,
				["(2) koop farben des glaubens"] = true,
				["(2) koop sturm auf etaqa"] = true,
				["(2) koop schatten und licht"] = true,
				["(2) koop heldenjagd"] = true,
				["(2) koop unter feindlicher kontrolle"] = true,
				["(2) koop verloren in evelance"] = true,
				["(2) koop erbe der koenige"] = true,
				["(2) koop die letzte hoffnung"] = true,
				["(2) koop die dunklen pyramiden"] = true,
				["(2) koop wettlauf mit der zeit"] = true,
				["(2) dunkelforst"] = true,
				["(2) kampf am kap"] = true,
				["(2) leichenfledderer"] = true,
				["(2) schnitters abenddaemmerung"] = true,
				["(2) schwefelwahn"] = true,
				["(2) skal"] = true,
				["(2) trommeln im moor"] = true,
				["(2) zerklueftete inseln"] = true,
				["(2) fort nogersund"] = true,
				["(2) grabenkampf"] = true,
				["(2) der taktiker"] = true,
				["(2) die alten imperien"] = true,
				["(2) hasenjagd"] = true
				},
			[3] =	{
				["(3) koop kalas zorn"] = true,
				["(3) koop kerberos dunkle horden"] = true,
				["(3) koop marys verrat"] = true,
				["(3) koop schlacht um evelance"] = true,
				["(3) koop vereinter widerstand"] = true,
				["(3) koop dunkelheit"] = true,
				["(3) koop vargs bergfestung"] = true,
				["(3) koop canyon"] = true,
				["(3) koop die grossen drei"] = true,
				["(3) koop barmecia"] = true,
				["(3) koop das grosse oedland"] = true,
				["(3) koop nachbarschaft"] = true,
				["(3) koop die erstuermung der wartburg"] = true,
				["(3) koop zu dunkler stunde"] = true,
				["(3) koop die schwarze festung"] = true,
				["(3) der lachende dritte"] = true,
				["(3) eingekesselt"] = true,
				["(3) hochland"] = true,
				["(3) gestrandet"] = true
				},
			[4] =	{
				["(4) koop angriff auf evelance"] = true,
				["(4) koop die smaragdebene"] = true,
				["(4) koop kalas giftnebel"] = true,
				["(4) koop marys intrige"] = true,
				["(4) koop die tore der stadt"] = true,
				["(4) koop oasenschlacht"] = true,
				["(4) koop belagerung von velborg"] = true,
				["(4) koop der gestohlene schatz"] = true,
				["(4) battle isle"] = true,
				["(4) eklipse"] = true,
				["(4) grosser wald des daemmerlichts"] = true,
				["(4) kaloix"] = true,
				["(4) kaltenberg"] = true,
				["(4) nachtmahr"] = true,
				["(4) nebelberge"] = true,
				["(4) nebelsteppe"] = true,
				["(4) toscana"] = true,
				["(4) schneetage"] = true,
				["(4) steppenkampf"] = true,
				["(4) tropensturm"] = true,
				["(4) die zusammenkunft"] = true,
				["(4) imperium"] = true,
				["(4) magic circle"] = true,
				["(4) sand cliffs"] = true,
				["(4) winterberge"] = true,
				["(4) winterliche bergpaesse"] = true,
				["(4) verschneites moor"] = true,
				["(4) battlestar"] = true,
				["(4) im graben der verdammnis"] = true,
				["(4) tal rasha"] = true,
				["(4) hasenjagd"] = true,
				["(4) der taktiker"] = true,
				["(4) winterzauber"] = true,
				["(4) sparrowdale"] = true,
				["(4) osterfieber"] = true,
				["(4) gezeiten"] = true,
				["(4) easterville"] = true,
				["(4) im zeichen ostaras"] = true
				},
			[5] = 	{
				["(5) koop der grosse aufstand"] = true,
				["(5) koop kerberos dunkle horden"] = true,
				["(5) koop vereinter widerstand"] = true,
				["(5) feste nuamyr"] = true,
				["(5) marys intrige"] = true,
				["(5) predominance"] = true,
				["(5) hochland"] = true
				},
			[6] =	{
				["(6) koop vargs raubzug"] = true,
				["(6) koop pfad der flammen"] = true,
				["(6) koop trockenzeit"] = true,
				["(6) die zwei burgherrn"] = true,
				["(6) heldenschlacht"] = true,
				["(6) hochland"] = true,
				["(6) inseln der ahnen"] = true,
				["(6) tropensturm"] = true,
				["(6) schneetage"] = true,
				["(6) riffe"] = true,
				["(6) schlacht von standrock"] = true
				},
			[7] = 	{
				["(7) koop vargs raubzug"] = true,
				["(7) blutmoor"] = true,
				["(7) wuesteninsel"] = true
				},
			[8] = 	{
				["(8) die kralberge"] = true,
				["(8) die zwei burgherrn"] = true,
				["(8) finsteres evelance"] = true,
				["(8) inferno"] = true,
				["(8) smaragdinseln"] = true,
				["(8) tropensturm"] = true,
				["(8) verrat"] = true,
				["(8) schneetage"] = true,
				["(8) death island"] = true,
				["(8) koenigreiche"] = true,
				["(8) grabraeuber"] = true
				},
			[9] = 	{
				},
			[10] =	{
				["(10) goldrausch"] = true,
				["(10) tropensturm"] = true,
				["(10) kuestenlandschaft"] = true,
				["(10) grabraeuber"] = true
				},
			[11] = 	{
				},
			[12] = 	{
				["(12) goldrausch"] = true,
				["(12) grabraeuber"] = true,
				["(12) tropensturm"] = true,
				["(12) wilde horden"] = true,
				["(12) voelkerschlacht"] = true
				}
			}

-- counting total Map amount (currently not used, just for information purpose)
do
	local i = table.getn(BS.MapList)

	while i > 0 do
		local count = 0
		for _ in pairs(BS.MapList[i]) do
			count = count + 1
		end
		BS.CurrentMappoolTotalAmount = BS.CurrentMappoolTotalAmount + count
		i = i - 1
	end
end
-- close game if map not validated
function BS.ValidateMap()
	if XNetwork.GameInformation_GetMapMaximumNumberOfHumanPlayer() > 0 then
		return BS.MapList[XNetwork.GameInformation_GetMapMaximumNumberOfHumanPlayer()][Framework.GetCurrentMapName()]
	else
		return true
	end
end

function BS.ValidateTextureQuality()
	if GDB.IsKeyValid( "Config\\Display\\TextureResolution" ) then
		return GDB.GetValue( "Config\\Display\\TextureResolution" ) == 0
	else
		return false
	end
end

BS.DateRestrictions = 	{MapName = {	["(4) hasenjagd"] =  	{
																	},
										["(4) imperium"] = 	{
																	},
										["(4) osterfieber"] = {
																	},
										["(4) easterville"] =	{
																	}
									},
						TechnologyForbidden = {	[1] = Technologies.B_VictoryStatue1,
												[2] = Technologies.B_VictoryStatue2,
												[3] = Technologies.B_VictoryStatue3,
												[4] = Technologies.B_VictoryStatue4,
												[5] = Technologies.B_VictoryStatue5,
												[6] = Technologies.B_VictoryStatue6,
												[7] = Technologies.B_VictoryStatue7,
												[8] = Technologies.B_VictoryStatue8,
												[9] = Technologies.B_VictoryStatue9,
												[10] = Technologies.MU_Cannon5,
												[11] = Technologies.MU_Cannon6,
												[12] = Technologies.MU_Catapult
												}
						}
for _, map in pairs(BS.DateRestrictions.MapName) do
	for i = 1, 9 do
		table.insert(map, "2022-05-0" .. i)
	end
	for i = 10, 14 do
		table.insert(map, "2022-05-" .. i)
	end
	for i = 29, 30 do
		table.insert(map, "2024-04-" .. i)
	end
	for i = 1, 9 do
		table.insert(map, "2024-05-0" .. i)
	end
	for i = 10, 31 do
		table.insert(map, "2024-05-" .. i)
	end
	for i = 1, 9 do
		table.insert(map, "2024-06-0" .. i)
	end
	for i = 10, 30 do
		table.insert(map, "2024-06-" .. i)
	end
end

function BS.CheckForDateRestrictions(_datestring)
	local month = tonumber(string.sub(_datestring, 6, 7))
	local day = tonumber(string.sub(_datestring, 9, 10))
	if (month == 12 and day >= 20) or (month == 1 and day <= 31) then
		--local sizeX, sizeY = Logic.WorldGetSize()
		-- if casted on valid position, not global but only a range of ~3000
		-- requires vision on position to be globally seen
		Logic.CreateEffect(GGL_Effects.FXSnow, 0, 0)
		local maxplayers = 1
		if CNetwork then
			maxplayers = 16
		end
		for player = 1,maxplayers do
			Logic.SetEntityExplorationRange(Logic.CreateEntity(Entities.XD_ScriptEntity, 0, 0+(player/100), 0, player), 1)
		end
		-- trigger for xmas tower upgrades
		Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_DESTROYED, "", "XMasTowerUpgraded", 1)
	end
	if BS.DateRestrictions.MapName[Framework.GetCurrentMapName()] ~= nil then
		for k,v in pairs(BS.DateRestrictions.MapName[Framework.GetCurrentMapName()]) do
			if string.find(_datestring, v, 0, string.len(v)) ~= nil then
				for i = 1,XNetwork.GameInformation_GetMapMaximumNumberOfHumanPlayer() do
					for x = 1,table.getn(BS.DateRestrictions.TechnologyForbidden) do
						ForbidTechnology(BS.DateRestrictions.TechnologyForbidden[x],i)
					end
				end
				XGUIEng.ShowWidget("BuyHeroWindowBuyHero14", 0)
			end
		end
	end
end

BS.AchievementNames = {	["Build_VictoryStatue1"] = "challenge_map1_won",
						["Build_VictoryStatue2"] = "challenge_map2_won",
						["Build_VictoryStatue3"] = "challenge_map3_won",
						["Build_VictoryStatue4"] = "challenge_map4_won",
						["Build_VictoryStatue5"] = "challenge_map5_won",
						["Build_VictoryStatue6"] = "challenge_map6_won",
						["Build_VictoryStatue7"] = "challenge_map7_won",
						["Build_VictoryStatue8"] = "challenge_map8_won",
						["Build_VictoryStatue9"] = "challenge_map9_won",
						["BuyHeroWindowBuyHero14"] = {	[1] = "challenge_map1_won",
														[2] = "challenge_map2_won",
														[3] = "challenge_map3_won"
													},
						["BS_ArmyCreator_Hero14"] = {	[1] = "challenge_map1_won",
														[2] = "challenge_map2_won",
														[3] = "challenge_map3_won"
													},
						["Buy_Catapult"] = {[1] = "challenge_map4_won",
											[2] = "challenge_map5_won",
											[3] = "challenge_map6_won"
											},
						["Buy_Cannon5"] = { [1] = "challenge_map7_won",
											[2] = "challenge_map8_won",
											[3] = "challenge_map9_won"
											},
						["BS_ArmyCreator_Cannon_T5"] = {[1] = "challenge_map7_won",
														[2] = "challenge_map8_won",
														[3] = "challenge_map9_won"
														},
						["Buy_Cannon6"] = {	[1] = "challenge_map1_won",
											[2] = "challenge_map2_won",
											[3] = "challenge_map3_won",
											[4] = "challenge_map4_won",
											[5] = "challenge_map5_won",
											[6] = "challenge_map6_won",
											[7] = "challenge_map7_won",
											[8] = "challenge_map8_won",
											[9] = "challenge_map9_won"
											},
						["BS_ArmyCreator_Cannon_T6"] = {[1] = "challenge_map1_won",
														[2] = "challenge_map2_won",
														[3] = "challenge_map3_won",
														[4] = "challenge_map4_won",
														[5] = "challenge_map5_won",
														[6] = "challenge_map6_won",
														[7] = "challenge_map7_won",
														[8] = "challenge_map8_won",
														[9] = "challenge_map9_won"
													}
					}

BS.AchievementWhitelist = {	[1] = {"Roma_Invicta", "CAS_G Roma",
									"CAS-G_Mathias", "Mathias", "G4F_Mathias",
									"DerEisenfresser",
									"ThePhoenix_2000",
									"Novator12", "Novator12Slave",
									"Vqrys",
									"ZorkManu",
									"Parzival42",
									"Izzo",
									"a8wh4t"},
							[2] = {"Roma_Invicta", "CAS_G Roma",
									"CAS-G_Mathias", "Mathias", "G4F_Mathias",
									"Novator12", "Novator12Slave",
									"ZorkManu",
									"RitterLeo",
									"DerEisenfresser",
									"ThePhoenix_2000",
									"Vqrys",
									"Izzo",
									"a8wh4t",
									"Parzival42",
									"morbus3"},
							[3] = {"Roma_Invicta", "CAS_G Roma",
									"CAS-G_Mathias", "Mathias", "G4F_Mathias",
									"Novator12", "Novator12Slave",
									"Vqrys",
									"Izzo",
									"a8wh4t",
									"ThePhoenix_2000",
									"DerEisenfresser"},
							[4] = {"Novator12", "Novator12Slave",
									"Vqrys",
									"Roma_Invicta", "CAS_G Roma",
									"CAS-G_Mathias", "Mathias", "G4F_Mathias"},
							[5] = {"Novator12", "Novator12Slave",
									"ThePhoenix_2000",
									"Vqrys",
									"Roma_Invicta", "CAS_G Roma",
									"CAS-G_Mathias", "Mathias", "G4F_Mathias"},
							[6] = {},
							[7] = {"Izzo",
									"a8wh4t",
									"ThePhoenix_2000",
									"Novator12", "Novator12Slave",
									"Vqrys",
									"CAS-G_Mathias", "Mathias", "G4F_Mathias",
									"Roma_Invicta", "CAS_G Roma"},
							[8] = {"ThePhoenix_2000",
									"Vqrys",
									"Novator12", "Novator12Slave"},
							[9] = {"CAS-G_Mathias", "Mathias", "G4F_Mathias",
									"Novator12", "Novator12Slave",
									"ThePhoenix_2000",
									"Vqrys",
									"DerEisenfresser"}
						}
function BS.CheckForAchievements(_pID)

	for i = 1,16 do
		if _pID == i then
			for k,v in pairs(BS.AchievementNames) do
				if type(v) == "string" then
					if GDB.GetValue(v) == 2 then
						XGUIEng.ShowWidget(k,1)
					else
						XGUIEng.ShowWidget(k,0)
					end
				elseif type(v) == "table" then
					local value = 0
					for j = 1, table.getn(v) do
						if GDB.GetValue(v[j]) == 2 then
							value = value + 1
						end
					end
					if value == table.getn(v) then
						XGUIEng.ShowWidget(k,1)
					else
						XGUIEng.ShowWidget(k,0)
					end
				end
			end
		end
	end
end

if CNetwork then
	if BS.ValidateMap() ~= true then
		Framework.CloseGame()
	end
	CLogger.Log("BS-Version: " .. BS.Version)
end
-- Score stuff
if not Score.Player[0] then
	Score.Player[0] = {
		battle = 0,
		buildings = 0,
		settlers = 2,
		all = 2,
		resources = 0,
		technology = 0,
	}
end

Score.WinPoints = 1
Score.ResearchPoints = 50
Score.UpgradePoints = 25
Score.BattleSettlersPoints = 3
Score.BattleBuildingPoints = 50
Score.SettlersPoints = 5
Score.ResourcePoints = 0.05
Score.ConstructionPoints = 5
-----------------------------------------------------------------------------------------------------------------------------
-------------------- important Balancing_Stuff... Stuff ^^ ; do not change or even delete -----------------------------------
-----------------------------------------------------------------------------------------------------------------------------

---------------------------------------------- loading scripts --------------------------------------------------------------
do
	local files = {
		"Weathersets",
		"CNetworkHandler",
		"Lighthouse",
		"MercenaryTower",
		"Lightning",
		"DZTradePunishment",
		"Comforts",
		"ChunkWrapper",
		"AI",
		"Castle",
		"Tower",
		"Archers_Tower",
		"Scaremonger",
		"Trigger",
		"CMod_Additions",
		"InterfaceTools",
		"GameCallbacks",
		"GUITooltips",
		"GUIUpdate",
		"GUIAction",
		"LocalMusic",
		"VersionCheck",
		"Hero6",
		"Hero9",
		"Hero13",
		"Hero14",
		"HeroTarget",
		"AI_heroAbilities",
		"VictoryStatues",
		"AnnivStatue20",
		"WCutter",
		"Forester",
		"Coal",
		"Cannon5",
		"Siege"
	};
	table.foreachi(files,function(_,_value)Script.Load("data\\script\\maptools\\tools\\".._value..".lua")end)
end
--needed to use etype instead of ucat for some functions(e.g. recruiting)
CUtil.EnableEntityTypeAsUgradeCategory()
--load special gfx
BS.GfxInit()
--disables the creation of fow (needed for minimap)
CUtil.DisableFoW()
--larger zoom factor (default 1.0)
Camera.ZoomSetFactorMax(2)
--needed for Victory
gvMission = gvMission or {}
gvMission.PlayerID = GUI.GetPlayerID()
--additional chat taunts added
if CNetwork then
	BonusKeys()
end
--internal payday activation (for treasury technology - debenture)
for i = 1,16 do
	CUtil.Payday_SetActive(i, true)
end
--initializing dz trade punishment
DZTrade_Init()
--initializing animations for beautifications
BeautiAnimCheck()
--loading widget helper
if not WidgetHelper then
	Script.Load("MP_SettlerServer/WidgetHelper.lua")
end
--additionaly load this script if there are any presents to steal on the map
if gvXmasEventFlag == 1 then
	Script.Load("data\\script\\maptools\\tools\\PresentControl.lua")
end
--additional AI buttons on et23 map
if gvET23Flag == 1 then
	WidgetHelper.AddPreCommitCallback(
	function()
		CWidget.Transaction_AddRawWidgetsFromFile("data\\script\\maptools\\tools\\EasterT23.xml", "Normal")
	end)
end
------------------------------------ initializing triggers -------------------------------------------------------
--Trigger for trading
Trigger.RequestTrigger(Events.LOGIC_EVENT_GOODS_TRADED, "", "TransactionDetails", 1)
--Trigger for special buildings (e.g. dome, silversmith, ...)
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "SpezEntityPlaced", 1)
--Trigger for salims trap
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "SalimTrapPlaced", 1)
--Trigger for castles
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "OnCastleCreated", 1)
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_DESTROYED, "", "OnCastleDestroyed", 1)
--Trigger for scaremongers
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_DESTROYED, "", "OnScaremongerDestroyed", 1)
--Trigger for towers
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "OnTowerCreated", 1)
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_DESTROYED, "", "OnTowerDestroyed", 1)
--Trigger for victory statues
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "OnVStatuesCreated", 1)
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_DESTROYED, "", "OnVStatuesDestroyed", 1)
--Trigger for drakes headshot
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_HURT_ENTITY, "", "DrakeHeadshotDamage", 1)
--Trigger for poison damage (kala, mary)
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_HURT_ENTITY, "", "PoisonDamageCreateDoT", 1)
--Trigger for yuki's shuriken damage
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_HURT_ENTITY, "", "YukiShurikenBonusDamage", 1)
--Trigger for kerberos attacks
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_HURT_ENTITY, "", "KerberosAttackAdditions", 1)
--Trigger for helias effects
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "OnHeliasCreated", 1)
--Trigger for ari troops
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "OnAriTroopCreated", 1)
--Trigger for erebos movement effects
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "OnErebos_Created", 1)
--Trigger for dovbar divine judjement
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "OnDovbar_Created", 1)
--Trigger for catapult stones effects
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_HURT_ENTITY, "", "CatapultStoneHitEffects", 1)
--Trigger for hero death
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_HURT_ENTITY, "", "OnHeroDied", 1)
--Trigger for archers towers
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_DESTROYED, "", "OnArchers_TowerDestroyed", 1)
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "OnArchers_TowerCreated", 1)
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_DESTROYED, "", "OnArchers_Tower_OccupiedTroopDied", 1)
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_HURT_ENTITY, "", "OnArchers_Tower_OccupiedTroopAttacked", 1)
--Trigger for serfs
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "SerfCreated", 1)
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_DESTROYED, "", "SerfDestroyed", 1)
StartCountdown(5,SerfHPRegen,false)
--Winter and Night sounds (wolfs howling, snowbird, etc.)
StartSimpleJob("WinterTheme")
--calculating ingame time (used for mechanical clock gui)
StartSimpleJob("IngameTimeJob")
--calculating player military score points (allow bloodrush if enough)
StartSimpleJob("BloodRushCheck")
--initializing lightning
StartSimpleJob("Lightning_Job")
--Trigger to get building ids for beauti anims
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_CREATED, "", "OnSpecBeautiCreated", 1)
--Trigger for evil stuff
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_HURT_ENTITY, "", "EvilTroll_AoEDMG", 1)
--Trigger for AI tower target redirection
AIchunks = {}
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_HURT_ENTITY, "", "AITower_RedirectTarget", 1)
--spectator QoL
Trigger.RequestTrigger(Events.LOGIC_EVENT_ENTITY_DESTROYED, "", "LocalMusic_Spectator_TriggerSettlerKilled", 1)
----------------------------------- loading GUI and special scripts (various for EMS and cooperation Maps) ----------------------------------
if not gvEMSFlag then
	Script.Load("data\\script\\maptools\\tools\\Sync.lua")
	function Sync.Send(_str)
		if CNetwork then
			XNetwork.Chat_SendMessageToAll(_str)
		else
			MPGame_ApplicationCallback_ReceivedChatMessage(_str, 0, GUI.GetPlayerID())
		end
	end
	Sync.Init()
	--
	BS.EnemyBuildBlockRange = 2500
	-- register AI in statistics
	local PIDs = GetAllAIs()
	for i = 1,table.getn(PIDs) do
		if gvPlayerName[PIDs[i]] then
			Logic.SetPlayerRawName(PIDs[i], gvPlayerName[PIDs[i]])
		else
			Logic.SetPlayerRawName(PIDs[i], "AI"..i)
		end
		Logic.PlayerSetIsHumanFlag(PIDs[i], 1)
		Logic.PlayerSetPlayerColor(PIDs[i], GUI.GetPlayerColor(PIDs[i]))
	end
else
	Script.Load("data\\script\\maptools\\tools\\EMSAdditions.lua")
	BS.EnemyBuildBlockRange = 1500
end
CWidget.LoadGUINoPreserve("data\\script\\maptools\\tools\\BS_GUI.xml")
-- check for valid texture quality settings
if BS.ValidateTextureQuality() ~= true then
	local text = "Bitte stellt Eure Texturqualität im Optionsmenü im Hauptmenü auf hoch und startet das Spiel neu!"
	if string.lower(XNetworkUbiCom.Tool_GetCurrentLanguageShortName()) ~= "de" then
		text = "Please visit the options menu in the main menu and change your texture quality settings to high! Afterwards, don't forget to restart your game!"
	end
	GUI.AddStaticNote(text)
end
BS.VersionCheck.Setup()
-- asynchronous check for achievements
BS.CheckForAchievements(GUI.GetPlayerID())
-- check for temporarily disabled technologies
BS.CheckForDateRestrictions(Framework.GetSystemTimeDateString())
-- anti sell building bug
BS.AC.Setup()
-- vstatue7 not available on coop maps
if not gvEMSFlag then
	XGUIEng.ShowWidget("Build_VictoryStatue7", 0)
end
--Simis Rotation Widget pushed to the left side, so it visually fits better in the upscaled GUI
XGUIEng.SetWidgetPosition("RotateBack",389, 4)
--give players their respective favorite color (if given/set in simis mp QoL)
if not CNetwork then
	if GDB.IsKeyValid("Config\\SettlerServer\\ColorPlayer") then
		local PlayerColor = GDB.GetValue("Config\\SettlerServer\\ColorPlayer")
		Display.SetPlayerColorMapping(1, PlayerColor)
	end
end
CUtil.ActivateTaskIncrementBugfix()